import os
import io
import requests
from PIL import Image
import zipfile
from urllib.parse import urlparse, parse_qs

class DriveImageAccess:
    def __init__(self, folder_url):
        """
        Initialize with Google Drive folder URL
        """
        self.folder_url = folder_url
        self.folder_id = self.extract_folder_id(folder_url)
        
    def extract_folder_id(self, url):
        """
        Extract folder ID from Google Drive URL
        """
        if '/folders/' in url:
            return url.split('/folders/')[1].split('?')[0]
        return None
    
    def get_download_link(self):
        """
        Generate download link for the entire folder as ZIP
        """
        if self.folder_id:
            return f"https://drive.google.com/uc?export=download&id={self.folder_id}"
        return None
    
    def download_folder_as_zip(self, output_path="drive_images.zip"):
        """
        Download the entire folder as a ZIP file
        Note: This works for publicly shared folders
        """
        download_url = f"https://drive.google.com/uc?export=download&id={self.folder_id}"
        
        try:
            # Start download session
            session = requests.Session()
            response = session.get(download_url, stream=True)
            
            # Handle Google's virus scan warning for large files
            if 'virus scan warning' in response.text.lower():
                # Extract confirmation token
                for key, value in response.cookies.items():
                    if key.startswith('download_warning'):
                        params = {'confirm': value, 'id': self.folder_id}
                        response = session.get(download_url, params=params, stream=True)
                        break
            
            # Download the file
            with open(output_path, 'wb') as f:
                for chunk in response.iter_content(chunk_size=8192):
                    if chunk:
                        f.write(chunk)
            
            print(f"Downloaded folder to {output_path}")
            return output_path
            
        except Exception as e:
            print(f"Error downloading folder: {e}")
            return None
    
    def extract_images_from_zip(self, zip_path, extract_to="extracted_images"):
        """
        Extract images from downloaded ZIP file
        """
        image_extensions = {'.jpg', '.jpeg', '.png', '.gif', '.bmp', '.tiff', '.webp'}
        extracted_images = []
        
        try:
            os.makedirs(extract_to, exist_ok=True)
            
            with zipfile.ZipFile(zip_path, 'r') as zip_ref:
                for file_info in zip_ref.filelist:
                    file_ext = os.path.splitext(file_info.filename)[1].lower()
                    
                    if file_ext in image_extensions:
                        # Extract the image file
                        zip_ref.extract(file_info, extract_to)
                        extracted_path = os.path.join(extract_to, file_info.filename)
                        extracted_images.append(extracted_path)
                        print(f"Extracted: {file_info.filename}")
            
            return extracted_images
            
        except Exception as e:
            print(f"Error extracting images: {e}")
            return []
    
    def process_images(self, image_paths):
        """
        Process extracted images (example: resize, convert format, etc.)
        """
        processed_images = []
        
        for img_path in image_paths:
            try:
                with Image.open(img_path) as img:
                    # Example processing: resize to max 800px width
                    if img.width > 800:
                        ratio = 800 / img.width
                        new_height = int(img.height * ratio)
                        img = img.resize((800, new_height), Image.Resampling.LANCZOS)
                    
                    # Save processed image
                    processed_path = img_path.replace('.', '_processed.')
                    img.save(processed_path, optimize=True, quality=85)
                    processed_images.append(processed_path)
                    
                    print(f"Processed: {os.path.basename(processed_path)}")
                    
            except Exception as e:
                print(f"Error processing {img_path}: {e}")
        
        return processed_images
    
    def get_all_images(self, download_zip=True, extract_images=True, process_images=False):
        """
        Main method to get all images from the shared folder
        """
        results = {
            'zip_path': None,
            'extracted_images': [],
            'processed_images': []
        }
        
        if download_zip:
            zip_path = self.download_folder_as_zip()
            results['zip_path'] = zip_path
            
            if extract_images and zip_path:
                extracted = self.extract_images_from_zip(zip_path)
                results['extracted_images'] = extracted
                
                if process_images and extracted:
                    processed = self.process_images(extracted)
                    results['processed_images'] = processed
        
        return results

# Usage example
def main():
    # Your shared Google Drive folder URL
    folder_url = "https://drive.google.com/drive/folders/1_OLhfCnXqA7Iqn4onMEB2HGCZsqNuGV5?usp=sharing"
    
    # Create DriveImageAccess instance
    drive_access = DriveImageAccess(folder_url)
    
    print(f"Folder ID: {drive_access.folder_id}")
    
    # Get all images
    results = drive_access.get_all_images(
        download_zip=True,
        extract_images=True,
        process_images=False  # Set to True if you want to process images
    )
    
    print("\n=== Results ===")
    print(f"ZIP file: {results['zip_path']}")
    print(f"Extracted images: {len(results['extracted_images'])}")
    print(f"Processed images: {len(results['processed_images'])}")
    
    # List all extracted images
    if results['extracted_images']:
        print("\nExtracted image files:")
        for img_path in results['extracted_images']:
            print(f"  - {img_path}")

if __name__ == "__main__":
    main()

# Alternative: Direct file access method (requires Google Drive API setup)
"""
For more advanced usage with individual file access, you'll need to:

1. Install Google Drive API client:
   pip install google-api-python-client google-auth-httplib2 google-auth-oauthlib

2. Set up authentication (create credentials.json from Google Cloud Console)

3. Use this alternative code:

from googleapiclient.discovery import build
from google.oauth2.service_account import Credentials

def access_drive_with_api(folder_id, credentials_path):
    # Authenticate
    creds = Credentials.from_service_account_file(credentials_path)
    service = build('drive', 'v3', credentials=creds)
    
    # List files in folder
    results = service.files().list(
        q=f"'{folder_id}' in parents and mimeType contains 'image/'",
        fields="files(id, name, mimeType, webContentLink)"
    ).execute()
    
    files = results.get('files', [])
    
    for file in files:
        print(f"File: {file['name']} ({file['mimeType']})")
        # Download individual files using file['webContentLink']
    
    return files
"""